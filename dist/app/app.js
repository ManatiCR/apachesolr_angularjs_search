!function(){"use strict";angular.module("apachesolrAngularjsSearch",["ngCookies","ngResource","ngSanitize","ngTouch","ui.select"]),Drupal.behaviors.apachesolrAngularjs={attach:function(e){function a(){function e(){var e=angular.element(document.getElementById("advanced-search-controller")),a=e.injector().get("drupalDataService");a.setDrupalData(n),e.scope().$apply()}var a=Drupal.settings.apachesolrAngularjs.fields,o=Drupal.settings.apachesolrAngularjs.pageId,r=Drupal.settings.apachesolrAngularjs.modulePath,l=Drupal.settings.apachesolrAngularjs.groups,t=Drupal.settings.apachesolrAngularjs.limitBy,n={fields:a,pageId:o,modulePath:r,groups:l,limitBy:t};angular.element(document).ready(e)}jQuery("#advancedSearch",e).once("advancedSearch",a),jQuery("div.ie9inf").length||angular.module("apachesolrAngularjsSearch").config(["$locationProvider",function(e){e.html5Mode(!0)}])}},Drupal.behaviors.apachesolrAngularjsNewGroup={attach:function(e){jQuery(".search-group-add-link",e).once("search-group-add",function(){jQuery(this).click(function(e){e.preventDefault();var a=jQuery(this).attr("href");jQuery.ajax({url:a,success:function(e){if(e){var a=JSON.parse(e);if(a){a=angular.copy(a);var o=angular.element(document.getElementById("advanced-search-controller")),r=o.injector().get("drupalDataService");r.setNewGroup(a),o.scope().$apply()}}}})})})}},Drupal.behaviors.apachesolrAngularjsNewTerm={attach:function(){if(Drupal.settings.apachesolrAngularjs.newTerm){var e=Drupal.settings.apachesolrAngularjs.newTerm;Drupal.settings.apachesolrAngularjs.newTerm=!1;var a=Drupal.settings.apachesolrAngularjs.groupIndex;Drupal.settings.apachesolrAngularjs.groupIndex=!1;var o=Drupal.settings.apachesolrAngularjs.fieldIndex;Drupal.settings.apachesolrAngularjs.fieldIndex=!1;var r={term:e,groupIndex:a,fieldIndex:o},l=angular.element(document.getElementById("advanced-search-controller")),t=l.injector().get("drupalDataService");t.setNewTerm(r),l.scope().$apply()}}},Drupal.ajax.prototype.trigger=function(){var e=this;if(e.ajaxing)return!1;try{jQuery.ajax(e.options)}catch(a){return console.log("An error occurred while attempting to process "+e.options.url),!1}return!1}}(),function(){"use strict";function e(e){function a(a){t=a,e.$emit("drupalDataReady")}function o(a){e.$emit("newGroupReady",a)}function r(a){e.$emit("newTermReady",a)}function l(){return t}var t={};return{setDrupalData:a,setNewGroup:o,setNewTerm:r,getDrupalData:l}}angular.module("apachesolrAngularjsSearch").factory("drupalDataService",["$rootScope",e])}(),function(){"use strict";function e(e){function a(e,a,r){return o.send({groups:e,limitBy:a,pageId:r}).$promise}var o=e("/apachesolr-angularjs-search",null,{send:{method:"POST"}});return{sendSearch:a}}angular.module("apachesolrAngularjsSearch").factory("searchPostService",["$resource",e])}(),function(){"use strict";function e(e){function a(e){return t.save({group:e}).$promise}function o(e){return t.update({group:e}).$promise}function r(){return t.index().$promise}function l(e){return t.index(e).$promise}var t=e("/apachesolr-angularjs-search/search-group/:id",{id:"@id"},{save:{method:"POST"},update:{method:"PUT"},index:{method:"GET",isArray:!0},get:{method:"GET",params:{id:0}}});return{saveGroup:a,updateGroup:o,getGroups:r,getGroup:l}}angular.module("apachesolrAngularjsSearch").factory("searchGroupService",["$resource",e])}(),function(){"use strict";function e(e,a){function o(e){function a(e){if(v||(v=e.target),44===e.charCode){h.booleansPopup.show=!0,m=v.selectionStart;var a=jQuery(".booleans-popup--container").next(".highlightTextarea").find(".form-text").width()-100,o=-75+6.5*(m+1);o=a>=o?o:a,jQuery(".booleans-popup--container").css("left",o+"px"),v.focus()}else h.booleansPopup.show=!1;return!0}function o(a,o){var r=null,l=!0;h.booleansPopup.itemToReplace?(r=h.booleansPopup.itemToReplace,h.booleansPopup.itemToReplace=null):"__fulltext_search"!==h.field.id&&h.firstBoolean&&h.firstBoolean!==a&&(l=!1);var t,i=!1;if(l){if(h.firstBoolean||(void 0===h.field.value[1]||"OR"!==h.field.value[1].name&&"AND"!==h.field.value[1].name&&"NOT"!==h.field.value[1].name?h.firstBoolean=a:(h.firstBoolean=h.field.value[1].name,i=!0)),h.field.autocompletePath){var s=h.field.value.length;if(r){var u=0;for(u=0;u<h.field.value.length;u++)if(r.id===h.field.value[u].id){1===u&&(h.firstBoolean=a);break}h.field.value.splice(u,1,{id:a+"-"+(s-1),name:a,"class":"advanced-search--field-autocomplete-operator"}),n()}else h.field.value.push({id:a+"-"+s,name:a,"class":"advanced-search--field-autocomplete-operator"}),jQuery(o.target).parents(".advanced-search--field-container").find(".ui-select-search").focus();setTimeout(function(){jQuery(".advanced-search--field-autocomplete-operator").parents(".ui-select-match-item").children(".ui-select-match-close").remove()},0)}else t=h.field.value.substr(m+1),h.field.value=h.field.value.substr(0,m),h.field.value+=" "+a+" ",h.field.value+=t;var p=a.length+2,d=m+p;v&&(v.focus(),setTimeout(function(){v.setSelectionRange(d,d)},0)),h.field.autocompletePath||setTimeout(function(){jQuery(e.element).find("textarea, input").data("highlighter").highlight()},0),i&&n()}else h.field.autocompletePath?setTimeout(function(){jQuery(e.element).parents(".advanced-search--field-container").next().find(".ui-select-search").focus()},0):(t=h.field.value.substr(m+1),h.field.value=h.field.value.substr(0,m),h.field.value+=t),e.$parent.main.addSameField(h.group.groupIndex,e.$parent.$index),e.$parent.main.groups[h.group.groupIndex].fields[e.$parent.$index+1].previousConnector=a.toLowerCase();h.booleansPopup.show=!1,h.field.avoidGlobalPopup=!1}function r(a,o){var r=a.value.substr(a.value.indexOf(o)+o.length,a.value.length-1).trim();return a.value=a.value.substr(0,a.value.indexOf(o)),e.$parent.main.addSameField(h.group.groupIndex,e.$parent.$index),e.$parent.main.groups[h.group.groupIndex].fields[e.$parent.$index+1].previousConnector=o,e.$parent.main.groups[h.group.groupIndex].fields[e.$parent.$index+1].value=r,r}function l(a,o){if(o.length)for(var t=o[0],n=1;n<o.length;n++)if(o[n]!==t){var i=r(a,o[n]),s=new RegExp("(AND|OR|NOT)"),u=i.match(s);null!==u&&l(e.$parent.main.groups[h.group.groupIndex].fields[e.$parent.$index+1],u);break}}function n(){var a=0,o=!1;for(a=0;a<h.field.value.length;a++)if("AND"===h.field.value[a].name||"OR"===h.field.value[a].name||"NOT"===h.field.value[a].name)if(o){if(o!==h.field.value[a].name){var r=h.field.value[a].name,l=h.field.value.splice(a,h.field.value.length-a);e.$parent.main.addSameField(h.group.groupIndex,e.$parent.$index),e.$parent.main.groups[h.group.groupIndex].fields[e.$parent.$index+1].previousConnector=r,e.$parent.main.groups[h.group.groupIndex].fields[e.$parent.$index+1].value=l.splice(1,l.length);break}}else o=h.field.value[a].name}function i(e){var a=e.matches;a.length?"__fulltext_search"!==h.field.id&&(l(h.field,a),jQuery(e.target).data("highlighter").highlight()):h.firstBoolean=""}function s(){if(h.field.value){h.parentScope.main.closeAllPopups(),h.booleansPopup.show=!0,angular.element(document.getElementsByClassName("ui-select-search")).on("keydown",u);jQuery(t).find(".ui-select-search")}else h.parentScope.main.closeAllPopups(),h.booleansPopup.show=!0}function u(){h.booleansPopup.show=!1}function p(e){var a=!1;if(e.value)for(var o=0;o<e.value.length;o++)if("advanced-search--field-autocomplete-operator"===e.value[o]["class"]){h.firstBoolean=e.value[o].name,a=!0;break}a||(h.firstBoolean=!1)}function d(e,a){if("advanced-search--field-autocomplete-operator"===e["class"]){h.booleansPopup.show=!0;for(var o=0;o<h.field.value.length;o++)h.field.value[o].id===e.id?(h.parentScope.main.closeAllPopups(),e.showPopup=!0):h.field.value[o].showPopup=!1;h.booleansPopup.itemToReplace=e,a.stopPropagation(),h.field.avoidGlobalPopup=!0}}function c(e,a,o,r){setTimeout(function(){void 0===r&&(r=e.target),void 0===a&&(a=e.pageX),void 0===o&&(o=e.pageY);var l=jQuery(r).parents(".advanced-search--form-item-container").children(".booleans-popup--container"),t=null!==jQuery(r).parents(".advanced-search--field-autocomplete").offset()?jQuery(r).parents(".advanced-search--field-autocomplete").offset().left:0,n=null!==jQuery(r).parents(".advanced-search--field-autocomplete").offset()?jQuery(r).parents(".advanced-search--field-autocomplete").offset().top:0,i=a-t-l.width()/2,s=o-n-l.height()/2-47;l.css("left",i+"px"),l.css("top",s+"px")},0)}function f(e){if(h.field.value.length){var a=h.field.value[h.field.value.length-1];"OR"!==a.name&&"AND"!==a.name&&"NOT"!==a.name?(h.parentScope.main.closeAllPopups(),h.booleansPopup.show=!0,h.field.avoidGlobalPopup=!1):(h.booleansPopup.show=!1,h.field.avoidGlobalPopup=!0)}else h.booleansPopup.show=!1,h.field.avoidGlobalPopup=!0;e.data={field:h.field}}function g(){h.booleansPopup.show=!1;for(var e=0;e<h.field.value.length;e++)h.field.value[e].showPopup&&(h.field.value[e].showPopup=!1)}var h=this;h.parentScope=e.$parent,h.booleansPopup=h.parentScope.main.booleansPopup={show:!1},h.textChange=a,h.addBoolean=o,h.highlightChange=i,h.optionSelected=s,h.removeChoice=p,h.openPopup=d,h.positionPopup=c,h.showBooleanIfNecessary=f,h.cleanShowPopup=g,h.firstBoolean="",h.field.avoidGlobalPopup=!1;var v,m;h.field.value||(h.field.value="")}function r(e,a){function o(){var o=jQuery(a).find(".form-textarea, .form-text");o.highlightTextarea({words:["AND","OR","NOT"],color:"#CCC",resizable:o.hasClass("form-textarea"),resizableOptions:{maxWidth:o.outerWidth(!0),minWidth:o.outerWidth(!0),minHeight:30}}),jQuery(a).bind("matchesChanged",e.vm.highlightChange),e.element=a}function r(){jQuery(".ui-select-container").once(function(){jQuery(this).click(function(){jQuery(this).find(".ui-select-search").focus()})})}function l(){setTimeout(function(){jQuery(".advanced-search--field-autocomplete-operator").parents(".ui-select-match-item").children(".ui-select-match-close").remove()},0)}function n(){setTimeout(function(){var o=e.vm;if(o.field.autocompletePath){var r=jQuery(a).children(".booleans-popup--container"),l=jQuery(a).find(".ui-select-search");l.wrap('<div class="booleans-popup-input--container"></div>'),jQuery(a).find(".booleans-popup-input--container").prepend(r)}},0)}t=a,setTimeout(o,0),setTimeout(r,0),setTimeout(l,0),setTimeout(n,0)}var l,t;e.$on("drupalDataReady",function(){var e=a.getDrupalData();l=e.modulePath});var n={templateUrl:"/sites/all/modules/custom/apachesolr_angularjs_search/src/components/booleansPopup/booleans-popup.html",restrict:"A",scope:{field:"=",group:"="},controller:o,controllerAs:"vm",bindToController:!0,link:r};return n}angular.module("apachesolrAngularjsSearch").directive("aasBooleansPopup",["$rootScope","drupalDataService",e])}(),function(){"use strict";function e(e,a){function o(){function e(e){a.selected=e,a.expanded=!1}var a=this;a.expanded=!1,a.selectItem=e}var r;e.$on("drupalDataReady",function(){var e=a.getDrupalData();r=e.modulePath});var l={templateUrl:"/sites/all/modules/custom/apachesolr_angularjs_search/src/components/booleansSelect/booleans-select.html",restrict:"A",scope:{options:"=aasBooleansSelectOptions",selected:"=ngModel"},controller:o,controllerAs:"vm",bindToController:!0};return l}angular.module("apachesolrAngularjsSearch").directive("aasBooleansSelect",["$rootScope","drupalDataService",e])}(),function(){"use strict";function e(e,a,o,r,l,t){var n=this;e.$on("drupalDataReady",function(){function i(e,a){return{id:e,name:e,position:a,internalConnector:"and",nextConnector:"and",fields:[],selectedFields:[],closeButtonVisible:[],activeCount:0,activeAddField:!1,differentFieldsCount:1}}function s(e,a){var o=angular.copy(n.groups[e].selectedFields[a]);o&&(n.groups[e].fields[a]=o,u(e,a),n.groups[e].saved=!1)}function u(e,a){void 0!==n.groups[e].selectedFields[a-1]&&void 0!==n.groups[e].selectedFields[a]&&(n.groups[e].selectedFields[a].id===n.groups[e].selectedFields[a-1].id?n.groups[e].selectedFields[a].hide=!0:n.groups[e].selectedFields[a].hide=!1),void 0!==n.groups[e].selectedFields[a+1]&&void 0!==n.groups[e].selectedFields[a]&&(n.groups[e].selectedFields[a+1].id===n.groups[e].selectedFields[a].id?n.groups[e].selectedFields[a+1].hide=!0:n.groups[e].selectedFields[a+1].hide=!1)}function p(e){var a;if(!e)return angular.copy(n.fields.selected[1]);for(a=0;a<n.fields.selected.length;a++)if(n.fields.selected[a].id===e)return angular.copy(n.fields.selected[a]);return!1}function d(e,a){var o=angular.copy(a),r=c(e,o);n.groups[e].fields[r-1]&&n.groups[e].fields[r-1].id===n.groups[e].fields[r].id&&(n.groups[e].fields[r].previousConnector="or"),g(e)}function c(e,a,o){var r=!1;return void 0===o&&(void 0===n.groups[e].activeCount&&(n.groups[e].activeCount=n.groups[e].fields.length),o=n.groups[e].activeCount,r=!0),n.groups[e].selectedFields.splice(o+1,0,a),u(e,o),n.groups[e].fields.splice(o+1,0,a),r&&(n.groups[e].activeAddField=!1),n.groups[e].activeCount++,n.groups[e].saved=!1,o}function f(e,a){n.groups[e].fields.splice(a,1),n.groups[e].selectedFields.splice(a,1),n.groups[e].activeCount--,u(e,a-1),g(e)}function g(e){for(var a=[],o=0;o<n.groups[e].fields.length;o++){var r=n.groups[e].fields[o];-1===a.indexOf(r.id)&&a.push(r.id)}n.groups[e].differentFieldsCount=a.length}function h(e,a){n.groups[e].fields[a].previousConnector||(n.groups[e].fields[a].previousConnector="and");var o=angular.copy(n.groups[e].fields[a]);o.value=[],c(e,o,a)}function v(){for(var e=n.groups.length,a=i("group_"+e,e),o=0;o<n.fields.always.length;o++)a.fields[o]=angular.copy(n.fields.always[o]),a.fields[o].value=void 0,a.fields[o].autocompletePath&&(a.fields[o].value=[]),a.activeCount++;a.selectedFields[0]=a.fields[0],n.groups.push(a)}function m(e){n.groups.splice(e,1),Q()}function y(e,a){a&&a.length>2&&(e.searching=!0,o.get("/"+e.autocompletePath+"/"+a).then(function(a){if(200===a.status){e.choices=[];for(var o=0;o<a.data.length;o++)j(e,a.data[o].id)||e.choices.push(a.data[o])}e.searching=!1}))}function j(e,a){if(!e.value)return e.value=[],!1;for(var o=0;o<e.value.length;o++)if(e.value[o].id===a)return!0;return!1}function b(e,a,o,r){a.stopPropagation();var l="choice-"+e.id,t=a.pageX,n=a.pageY-250;if(!e.clicked){e.clicked=!0;var i=a.target;angular.element(i).on("click",Drupal.CTools.Modal.clickAjaxLink);var s={};s.url="/"+e.path+"/"+o+"/"+r,s.event="click",s.setClick=!0,Drupal.ajax[l]=new Drupal.ajax(l,i,s)}window.scroll(t,n),Drupal.ajax[l].trigger()}function P(){for(n.groups=[],n.groups[0]=i("default",0),B=0;B<n.fields.always.length;B++)n.groups[0].fields[B]=n.fields.always[B],n.groups[0].fields[B].value=void 0,n.groups[0].fields[B].autocompletePath&&(n.groups[0].fields[B].value=[]),n.groups[0].activeCount++;for(n.groups[0].selectedFields[0]=n.groups[0].fields[0],n.selectedField=p("__fulltext_search"),B=0;B<n.fields.limitby.length;B++)if(n.fields.limitby[B].value=void 0,n.fields.limitby[B].autocompletePath&&(n.fields.limitby[B].value=[]),n.fields.limitby[B].value2&&(n.fields.limitby[B].value2=void 0),"group"===n.fields.limitby[B].type){var e=0;for(e=0;e<n.fields.limitby[B].fields.length;e++)n.fields.limitby[B].fields[e].value=void 0}}function x(){n.processingSearch=!0,l.sendSearch(n.groups,n.fields.limitby,O).then(function(e){var o=e.uri;if(!jQuery("div.ie9inf").length){var r=e.aasBaseUrl,l=e.searchFormPath,t=o.replace("apachesolr-angularjs-search","advancedsearch");a.path(t).replace(r,l)}window.location.href=o})}function $(e){n.groups[e].name=n.groups[e].tempName,n.groups[e].processingSave=!0,n.groups[e].saving=!1,n.groups[e].saved=!0,t.saveGroup(n.groups[e]).then(function(a){200===a.status&&(n.groups[e].processingSave=!1,n.groups[e].tempName=void 0)})}function S(e){var a=0;for(a=0;a<e.fields.length;a++)if(e.fields[a].value)return!1;return!0}function w(){for(var e=0;e<n.groups.length;e++)for(var a=0;a<n.groups[e].fields.length;a++)if(n.groups[e].fields[a].avoidGlobalPopup=!0,n.groups[e].fields[a].autocompletePath&&void 0!==n.groups[e].fields[a].value&&n.groups[e].fields[a].value.length)for(var o=0;o<n.groups[e].fields[a].value.length;o++)n.groups[e].fields[a].value[o].showPopup&&(n.groups[e].fields[a].value[o].showPopup=!1)}function D(e,a){var o=C(e,a);o===!1?(a.value&&a.multiple||(a.value=[]),a.value.push(e)):a.value.splice(o,1)}function C(e,a){var o=0;if(a.value)for(o=0;o<a.value.length;o++)if(a.value[o]===e)return o;return!1}function A(e,a){27===e.keyCode&&(n.groups[a].saving=!1)}function T(e){e.choices=[]}function Q(){for(var e=0;e<n.groups.length;e++)n.groups[e].groupIndex=e}function F(){jQuery(".ui-select-container").once(function(){jQuery(this).click(function(){jQuery(this).find(".ui-select-search").focus()})}),jQuery(".advanced-search--container").once("click",function(){jQuery(this).click(function(e){if(void 0!==e.originalEvent.data)var a=e.originalEvent.data.field;for(var o=0;o<n.groups.length;o++)for(var r=0;r<n.groups[o].fields.length;r++){var l=n.groups[o].fields[r];if(l.autocompletePath)if(a)if(l.$$hashKey===a.$$hashKey){if(l.value.length){var t=l.value[l.value.length-1];("OR"===t.name||"AND"===t.name||"NOT"===t.name)&&(l.avoidGlobalPopup=!0)}}else l.avoidGlobalPopup=!0;else l.avoidGlobalPopup=!0}})})}e.$on("newGroupReady",function(e,a){a.processingSave=!1,n.groups.push(a),Q()}),e.$on("newTermReady",function(e,a){var o=a.groupIndex,r=a.fieldIndex,l=a.term;void 0===n.groups[o].fields[r].value&&(n.groups[o].fields[r].value=[]),j(n.groups[o].fields[r],l.id)||(n.groups[o].fields[r].value.push({id:l.id,name:l.name}),Drupal.CTools.Modal.dismiss(),jQuery("body").unbind("keypress"),n.groups[o].fields[r].choices=[],jQuery(jQuery(jQuery(".advanced-search--group-content")[o]).find(".advanced-search--field-container")[r]).find(".ui-select-search").val(""))}),n.clearForm=P,n.processForm=x,n.fieldChanged=s,n.addFieldConfirm=d,n.deleteField=f,n.addSameField=h,n.addSearchGroup=v,n.deleteGroup=m,n.saveGroup=$,n.getChoices=y,n.startPopup=b,n.selectOption=D,n.isOptionSelected=C,n.groupNameKeypress=A,n.clearChoices=T,n.isGroupEmpty=S,n.closeAllPopups=w,n.fields={},n.groups=[],n.operators=[];var G=angular.element(document.getElementById("mainController"));angular.element(G).unbind("drupalDataReady");var I,B,N=r.getDrupalData(),k=N.fields,O=N.pageId,R=N.groups,_=N.limitBy;for(I in k)for(B=0;B<k[I].length;B++)"boolean"===k[I][B].type?k[I][B].type="checkbox":"string"===k[I][B].type?k[I][B].type="text":"numeric"===k[I][B].type&&(k[I][B].type="number");if(n.fields=k,_&&(n.fields.limitby=_),R)n.groups=R;else{for(n.groups[0]=i("default",0),B=0;B<n.fields.always.length;B++)n.groups[0].fields[B]=angular.copy(n.fields.always[B]),n.groups[0].activeCount++;n.groups[0].selectedFields[0]=n.groups[0].fields[0]}n.selectedField=p("__fulltext_search"),n.operators=["and","or","not"],setTimeout(F,0)})}e.$inject=["$rootScope","$location","$http","drupalDataService","searchPostService","searchGroupService"],angular.module("apachesolrAngularjsSearch").controller("mainController",e)}();